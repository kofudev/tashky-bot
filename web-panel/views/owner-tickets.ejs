<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé´ Gestion Tickets - Owner Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .ticket-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .ticket-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        .ticket-status {
            padding: 0.25rem 0.75rem;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-open {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            color: #000;
        }
        
        .status-closed {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: #fff;
        }
        
        .ticket-type {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .type-support {
            background: rgba(72, 202, 228, 0.2);
            color: #48cae4;
            border: 1px solid #48cae4;
        }
        
        .type-report {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        
        .type-other {
            background: rgba(156, 136, 255, 0.2);
            color: #9c88ff;
            border: 1px solid #9c88ff;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .filter-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: scale(1.05);
        }
        
        .filter-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .ticket-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-danger-action {
            background: linear-gradient(135deg, #ff4757, #c44569);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .btn-danger-action:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }
    </style>
</head>
<body class="text-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px);">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/owner">
                <div class="me-3">
                    <i class="fas fa-ticket-alt fa-2x text-primary"></i>
                </div>
                <div>
                    <h4 class="mb-0 text-primary">GESTION TICKETS</h4>
                    <small class="text-muted">Supervision globale</small>
                </div>
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/owner">
                    <i class="fas fa-arrow-left me-2"></i>
                    Retour au Panel
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Statistiques -->
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-ticket-alt fa-2x text-success mb-2"></i>
                <h3 class="text-white" id="active-count">0</h3>
                <p class="text-muted mb-0">Tickets Actifs</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle fa-2x text-info mb-2"></i>
                <h3 class="text-white" id="closed-count">0</h3>
                <p class="text-muted mb-0">Tickets Ferm√©s</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-tools fa-2x text-warning mb-2"></i>
                <h3 class="text-white" id="support-count">0</h3>
                <p class="text-muted mb-0">Support Technique</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                <h3 class="text-white" id="report-count">0</h3>
                <p class="text-muted mb-0">Signalements</p>
            </div>
        </div>

        <!-- Filtres -->
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">
                <i class="fas fa-list me-1"></i>
                Tous les tickets
            </button>
            <button class="filter-tab" data-filter="active">
                <i class="fas fa-clock me-1"></i>
                Tickets actifs
            </button>
            <button class="filter-tab" data-filter="closed">
                <i class="fas fa-check me-1"></i>
                Tickets ferm√©s
            </button>
            <button class="filter-tab" data-filter="support">
                <i class="fas fa-tools me-1"></i>
                Support
            </button>
            <button class="filter-tab" data-filter="report">
                <i class="fas fa-flag me-1"></i>
                Signalements
            </button>
        </div>

        <!-- Actions globales -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="ticket-card">
                    <h5 class="text-white mb-3">
                        <i class="fas fa-cogs me-2"></i>
                        Actions Globales
                    </h5>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-warning" onclick="refreshTickets()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Actualiser
                        </button>
                        <button class="btn btn-outline-info" onclick="exportTickets()">
                            <i class="fas fa-download me-1"></i>
                            Exporter
                        </button>
                        <button class="btn btn-outline-danger" onclick="closeAllInactive()">
                            <i class="fas fa-times-circle me-1"></i>
                            Fermer Inactifs
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des tickets -->
        <div class="row">
            <div class="col-12">
                <div id="tickets-container">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Chargement des tickets...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allTickets = { active: [], closed: [] };
        let currentFilter = 'all';
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            setupFilterTabs();
            loadTickets();
        });
        
        // Configuration des onglets de filtre
        function setupFilterTabs() {
            const filterTabs = document.querySelectorAll('.filter-tab');
            filterTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Retirer la classe active de tous les onglets
                    filterTabs.forEach(t => t.classList.remove('active'));
                    // Ajouter la classe active √† l'onglet cliqu√©
                    this.classList.add('active');
                    
                    currentFilter = this.dataset.filter;
                    displayTickets();
                });
            });
        }
        
        // Charger les tickets
        function loadTickets() {
            fetch('/api/owner/tickets')
                .then(response => response.json())
                .then(data => {
                    allTickets = data;
                    updateStats(data.stats);
                    displayTickets();
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des tickets:', error);
                    document.getElementById('tickets-container').innerHTML = `
                        <div class="text-center text-danger py-5">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Erreur lors du chargement des tickets</p>
                        </div>
                    `;
                });
        }
        
        // Mettre √† jour les statistiques
        function updateStats(stats) {
            document.getElementById('active-count').textContent = stats.totalActive;
            document.getElementById('closed-count').textContent = stats.totalClosed;
            document.getElementById('support-count').textContent = stats.byType.support || 0;
            document.getElementById('report-count').textContent = stats.byType.report || 0;
        }
        
        // Afficher les tickets selon le filtre
        function displayTickets() {
            const container = document.getElementById('tickets-container');
            let ticketsToShow = [];
            
            switch (currentFilter) {
                case 'all':
                    ticketsToShow = [...allTickets.active, ...allTickets.closed.slice(0, 20)];
                    break;
                case 'active':
                    ticketsToShow = allTickets.active;
                    break;
                case 'closed':
                    ticketsToShow = allTickets.closed.slice(0, 50);
                    break;
                case 'support':
                    ticketsToShow = [...allTickets.active, ...allTickets.closed].filter(t => t.type === 'support');
                    break;
                case 'report':
                    ticketsToShow = [...allTickets.active, ...allTickets.closed].filter(t => t.type === 'report');
                    break;
            }
            
            if (ticketsToShow.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-2x mb-3"></i>
                        <p>Aucun ticket trouv√© pour ce filtre</p>
                    </div>
                `;
                return;
            }
            
            const ticketsHtml = ticketsToShow.map(ticket => createTicketCard(ticket)).join('');
            container.innerHTML = ticketsHtml;
        }
        
        // Cr√©er une carte de ticket
        function createTicketCard(ticket) {
            const isActive = ticket.status === 'open';
            const statusClass = isActive ? 'status-open' : 'status-closed';
            const statusText = isActive ? 'Ouvert' : 'Ferm√©';
            const typeClass = `type-${ticket.type}`;
            const typeText = getTypeText(ticket.type);
            
            const createdDate = new Date(ticket.createdAt).toLocaleString('fr-FR');
            const closedDate = ticket.closedAt ? new Date(ticket.closedAt).toLocaleString('fr-FR') : null;
            
            return `
                <div class="ticket-card">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="text-white mb-1">
                                <i class="fas fa-ticket-alt me-2"></i>
                                Ticket #${ticket.id}
                            </h5>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <span class="ticket-status ${statusClass}">${statusText}</span>
                                <span class="ticket-type ${typeClass}">${typeText}</span>
                                ${ticket.priority ? `<span class="badge bg-warning">${ticket.priority}</span>` : ''}
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">ID: ${ticket.id}</small>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">
                                <i class="fas fa-user me-1"></i>
                                <strong>Utilisateur:</strong> ${ticket.user}
                            </p>
                            <p class="text-muted mb-1">
                                <i class="fas fa-server me-1"></i>
                                <strong>Serveur:</strong> ${ticket.guild}
                            </p>
                            <p class="text-muted mb-0">
                                <i class="fas fa-calendar me-1"></i>
                                <strong>Cr√©√©:</strong> ${createdDate}
                            </p>
                        </div>
                        <div class="col-md-6">
                            ${ticket.claimedBy ? `
                                <p class="text-muted mb-1">
                                    <i class="fas fa-hand-paper me-1"></i>
                                    <strong>Pris en charge:</strong> Oui
                                </p>
                            ` : ''}
                            ${closedDate ? `
                                <p class="text-muted mb-1">
                                    <i class="fas fa-times me-1"></i>
                                    <strong>Ferm√©:</strong> ${closedDate}
                                </p>
                            ` : ''}
                            ${ticket.reason ? `
                                <p class="text-muted mb-0">
                                    <i class="fas fa-comment me-1"></i>
                                    <strong>Raison:</strong> ${ticket.reason.substring(0, 50)}${ticket.reason.length > 50 ? '...' : ''}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${isActive ? `
                        <div class="ticket-actions">
                            <button class="btn btn-sm btn-outline-info" onclick="viewTicket('${ticket.id}')">
                                <i class="fas fa-eye me-1"></i>
                                Voir
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="teleportToTicket('${ticket.channelId}')">
                                <i class="fas fa-external-link-alt me-1"></i>
                                Aller au salon
                            </button>
                            <button class="btn btn-sm btn-danger-action" onclick="forceCloseTicket('${ticket.id}')">
                                <i class="fas fa-times me-1"></i>
                                Fermer (Force)
                            </button>
                        </div>
                    ` : `
                        <div class="ticket-actions">
                            <button class="btn btn-sm btn-outline-info" onclick="viewTicket('${ticket.id}')">
                                <i class="fas fa-eye me-1"></i>
                                Voir
                            </button>
                            ${ticket.transcript ? `
                                <button class="btn btn-sm btn-outline-success" onclick="downloadTranscript('${ticket.id}')">
                                    <i class="fas fa-download me-1"></i>
                                    Transcript
                                </button>
                            ` : ''}
                        </div>
                    `}
                </div>
            `;
        }
        
        // Obtenir le texte du type de ticket
        function getTypeText(type) {
            const types = {
                support: 'üõ†Ô∏è Support',
                report: 'üö® Signalement',
                economy: 'üí∞ √âconomie',
                games: 'üéÆ Jeux',
                other: '‚ùì Autre'
            };
            return types[type] || '‚ùì Autre';
        }
        
        // Actions sur les tickets
        function viewTicket(ticketId) {
            // TODO: Ouvrir une modal avec les d√©tails du ticket
            alert(`Voir les d√©tails du ticket #${ticketId}`);
        }
        
        function teleportToTicket(channelId) {
            // Ouvrir Discord avec le lien du salon
            window.open(`https://discord.com/channels/@me/${channelId}`, '_blank');
        }
        
        function forceCloseTicket(ticketId) {
            if (confirm(`‚ö†Ô∏è √ätes-vous s√ªr de vouloir fermer de force le ticket #${ticketId} ?\n\nCette action est irr√©versible.`)) {
                const reason = prompt('Raison de la fermeture forc√©e:') || 'Fermeture forc√©e par owner';
                
                fetch(`/api/owner/tickets/${ticketId}/force-close`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        loadTickets(); // Recharger les tickets
                    } else {
                        showNotification(data.error || 'Erreur lors de la fermeture', 'error');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    showNotification('Erreur lors de la fermeture du ticket', 'error');
                });
            }
        }
        
        function downloadTranscript(ticketId) {
            // TODO: T√©l√©charger le transcript
            alert(`T√©l√©charger le transcript du ticket #${ticketId}`);
        }
        
        // Actions globales
        function refreshTickets() {
            showNotification('Actualisation des tickets...', 'info');
            loadTickets();
        }
        
        function exportTickets() {
            // TODO: Exporter les donn√©es des tickets
            alert('Export des tickets en cours de d√©veloppement');
        }
        
        function closeAllInactive() {
            if (confirm('‚ö†Ô∏è Fermer tous les tickets inactifs depuis plus de 24h ?\n\nCette action est irr√©versible.')) {
                // TODO: Impl√©menter la fermeture des tickets inactifs
                alert('Fermeture des tickets inactifs en cours de d√©veloppement');
            }
        }
        
        // Syst√®me de notifications
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'linear-gradient(135deg, #43e97b, #38f9d7)',
                error: 'linear-gradient(135deg, #ff4757, #c44569)',
                warning: 'linear-gradient(135deg, #feca57, #ff9ff3)',
                info: 'linear-gradient(135deg, #667eea, #764ba2)'
            };
            
            const notification = document.createElement('div');
            notification.className = 'position-fixed top-0 end-0 m-3 p-3 rounded';
            notification.style.zIndex = '9999';
            notification.style.background = colors[type];
            notification.style.color = 'white';
            notification.style.backdropFilter = 'blur(10px)';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Auto-refresh toutes les 30 secondes
        setInterval(loadTickets, 30000);
    </script>
</body>
</html>